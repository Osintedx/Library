-- First run the update command and ensure that the borrow_records.sql files for dummy values is NOT included.
-- Then Run this code in mysql workbench to create the trigger. Liquibase doesnt support mysql triggers...
-- Then uncomment the borrow_record.sql file and run the liquibase command again.
DELIMITER $$

CREATE TRIGGER update_book_rating_after_insert
        AFTER INSERT ON scrum_library.borrow_record
        FOR EACH ROW
        BEGIN
            IF NEW.rating IS NOT NULL THEN
                UPDATE scrum_library.book AS b
                SET
                    b.sum_rating = b.sum_rating + NEW.rating,
                    b.count_rating = b.count_rating + 1,
                    b.average_rating = (b.sum_rating + NEW.rating) / (b.count_rating + 1),
                    b.times_borrowed = b.times_borrowed + 1
                WHERE b.book_id = (
                    SELECT bc.book_book_id
                    FROM scrum_library.book_copy AS bc
                    WHERE bc.book_copy_id = NEW.book_copy_book_copy_id
                );
            END IF;
        END$$;

DELIMITER ;
